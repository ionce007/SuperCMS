<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="description" content="{{site.description}}">
  <meta name="keywords" content="{{site.keywords}}" />
  <meta property="og:title" content="{{site.title}}" />
  <meta property="og:description" content="{{site.description}}" />
  <title>{{site.title}}-基于大数据的股票交易策略</title>
  {{include './common/meta.html'}}
  <link rel="stylesheet" href="{{static_url}}/css/font-awesome.all.min.css" />
  <link rel="stylesheet" href="{{static_url}}/css/stock.css" />
  <script src="{{static_url}}/js/stock.js"></script>
  <style>
    .tooltip {
      position: fixed;
      padding: clamp(10px, 1.5vw, 12px) clamp(12px, 2vw, 16px);
      background: rgb(206 213 226 / 97%);
      /* rgba(20, 25, 35, 0.97);*/
      border-radius: 8px;
      color: #000;
      /* #ffffff;*/
      font-size: clamp(12px, 1.5vw, 14px);
      pointer-events: none;
      /*box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);*/
      border: 1px solid #3a3f50;
      z-index: 1000;
      max-width: min(300px, 90vw);
      backdrop-filter: blur(5px);
      opacity: 0.5;
      transition: opacity 0.2s ease;
      transform-origin: center;
    }

    .tooltip h3 {
      margin-bottom: 6px;
      color: #000;
      /* #00b4d8;*/
      font-size: clamp(14px, 2vw, 16px);
    }

    .tooltip p {
      margin: 4px 0;
      display: flex;
      justify-content: space-between;
    }

    .tooltip span.value {
      font-weight: bold;
      color: #000;
      /*#ff9e00;*/
    }

    .tooltip span.label {
      color: #000;
      /* #a0a0c0;*/
    }
  </style>
</head>

<body class="bg-f8f8f8">
  <!-- 头部 -->
  {{include './common/header.html'}}
  <div class="limit-tab-container">
    <h1 class="page-title timeline-title-w100">主力资金</h1>
    <div class="tab-content flex-grid pl-10 pr-10">
      <div class="chart-layout" data-key="block">
        <span class="ft-12">板块类型：</span>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 active" data-key="concept">概念板块</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5" data-key="industry">行业板块</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5" data-key="style">风格板块</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5" data-key="region">地区板块</button>
      </div>
      <div class="chart-layout only-chart" data-key="sort">
        <span class="ft-12">排序方式：</span>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 active" data-key="fundin">净流入</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5" data-key="fundout">净流出</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5" data-key="changeup">按涨幅</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5" data-key="changedown">按跌幅</button>
      </div>
      <div class="chart-layout only-chart" data-key="period">
        <span class="ft-12">统计周期：</span>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10 active" data-key="currday">当日明细</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="buytoday">今日增仓</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="buy3d">3日</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="buy5d">5日</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="buy10d">10日</button>
      </div>
      <div class="chart-layout only-chart" data-key="count">
        <span class="ft-12">显示数量：</span>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10 active" data-key="10">前10</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="20">前20</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="30">前30</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="50">前50</button>
        <button class="tab-btn-quality tab-tag heatmap ft-12 padding-5 pl-10 pr-10" data-key="100">前100</button>
      </div>
    </div>
    <div class="tab-content" id="mainTabContent">
      <div id="tab1" class="tab-pane tab-data-container pl-5 pr-5 active">
        <div class='no-auction-data nodisplay' id="nodataChart">暂无数据</div>
        <div class="chart-content" id="heatmapBlock" style="min-height:500px;"></div>
      </div>
      <div id="tab2" class="tab-pane tab-data-container pl-5 pr-5">
        <div class="chart-content" id="heatmapStock" style="min-height:700px;"></div>
      </div>
    </div>
  </div>

  {{include './common/footer.html'}}
  <!--<div class=" ignore mb-20 mt-20 pd-20 bg-f2f2f2">
      <h1>SuperCMS 当前页面数据：</h1>
      <p class="mb-20">data-> {{conceptBlock}} </p>
  </div>-->
  <!-- 移动端导航 -->
  {{include './common/wap-nav.html'}}

  {{include './common/js.html'}}
  <!--<script src="{{static_url}}/js/optionSelect.js"></script>-->
  <script src="{{static_url}}/js/echarts.min.js"></script>
  <!--<script src="{{static_url}}/js/stockChart.js"></script>-->
  <script src="{{static_url}}/js/textcolor.js"></script>
  <script src="{{static_url}}/js/treemap.js"></script>
</body>
<script>
  // 指定的颜色渐变方案
  const initData = JSON.parse(decodeHtmlEntities(`{{ conceptBlock }}`))
  window.heatmapChart = null;
  document.addEventListener('DOMContentLoaded', async () => {
    setConitionFontSize();
    if(!initData || !initData.data || !initData.data.diff || initData.data.diff[0].f62 === '-') document.getElementById('nodataChart').classList.remove('nodisplay');
    else{
      document.getElementById('heatmapBlock').innerHTML = '';
      const options = { block: 'concept', sort: 'fundin', period: 'currday', count: '10' }
      const chartData = await convert2ChartData(initData, options)
      const title = getChartTitle();
      initEChart(chartData, 'heatmapBlock', 'fund', title)
    }
    
    document.querySelectorAll('.tab-tag').forEach(tab => {
      tab.addEventListener('click', async function(event){
        if (event.target.classList.contains('active')) return;
        await renderChart();
      });
  })
  window.addEventListener('resize', () => {
    if(heatmapChart) heatmapChart.resize();
    setConitionFontSize();
  });
});
function getChartTitle(){
  let title = "", subtitle = '';
  let label = { amount: '资金流入：', change: '涨跌幅：'}
  const block = document.querySelector(".chart-layout[data-key = 'block'] > .heatmap.active").textContent;
  const sort = document.querySelector(".chart-layout[data-key = 'sort'] > .heatmap.active").getAttribute('data-key');
  const period = document.querySelector(".chart-layout[data-key = 'period'] > .heatmap.active").getAttribute('data-key');
  const periodValue = document.querySelector(".chart-layout[data-key = 'period'] > .heatmap.active").textContent.replaceAll('增仓', '');
  label.amount = '资金流入：' ;
  if(period.indexOf('buy') >= 0){
    label.change = '增仓占比：'
    if(sort.indexOf('fund') >= 0) { 
      const desc = sort === 'fundin' ? `主力${periodValue}增仓` : `主力${periodValue}减仓`;
      title = `${block}${desc}热力图`; 
    }
    else { 
      const desc = sort === 'changeup' ? `主力${periodValue}增仓占比` : `主力${periodValue}减仓占比`;
      title = `${block}${desc}热力图`; 
    }
  }
  else{
    label.change = '涨跌幅：'
    if(sort.indexOf('fund') >= 0) { title = `${block}${sort === 'fundin' ? '资金净流入' : '资金净流出'}热力图`; }
    else { title = `${block}${sort === 'changeup' ? '涨幅' : '跌幅'}热力图`; }
  }
  return { title, subtitle, label };
} 
async function renderChart(){
    const parentKey = event.target.parentElement.getAttribute('data-key');
    document.querySelectorAll(`.chart-layout[data-key = '${parentKey}'] > .heatmap`).forEach(item=>{ item.classList.remove('active') });
    event.target.classList.add('active');
    const block = document.querySelector(".chart-layout[data-key='block'] > .heatmap.active").getAttribute('data-key');
    const sort = document.querySelector(".chart-layout[data-key='sort'] > .heatmap.active").getAttribute('data-key');
    const period = document.querySelector(".chart-layout[data-key='period'] > .heatmap.active").getAttribute('data-key');
    const count = document.querySelector(".chart-layout[data-key='count'] > .heatmap.active").getAttribute('data-key');
    if(period.indexOf('buy') >= 0){
      document.querySelector("button[data-key='changeup']").textContent = '增仓占比上升'
      document.querySelector("button[data-key='changedown']").textContent = '增仓占比下降'
    }
    else{
      document.querySelector("button[data-key='changeup']").textContent = '按涨幅'
      document.querySelector("button[data-key='changedown']").textContent = '按跌幅'
    }
    const url = `/api/d/blockfunds/${block}/${sort}/?pz=${count}`;
    const res = await fetch(url);
    const data = await res.json();
    const currView = sort.indexOf('change') >= 0 ? 'change' : 'fund';
    if(!data || !data.data || !data.data.diff || data.data.diff[0].f62 === '-') document.getElementById('nodataChart').classList.remove('nodisplay');
    const options = { block, sort, period, count };
    const chartData = await convert2ChartData(data, options); 
    const title = getChartTitle();
    updateChart(chartData, currView, title);
  }
async function convert2ChartData(rawData, options = { block: 'concept', sort: 'fundin', period: 'currday', count: '10' }){
  const rtData = rawData.data.diff;
  const buyData = rawData.data.buyData.result.data;
  const result = await Promise.all( rtData.map( async item => {
    const name = item.f14;
    const code = item.f12;
    let amount, change;
    let buyItem = buyData.find(x=>x.INDEX_CODE === code);
    if(!buyItem) buyItem = await getPeriodData(code);
    if(options.period === 'buytoday'){ amount = item.f62; change = item.f184 }
    else if(options.period === 'buy3d'){ amount = !buyItem ? 0 : buyItem.MAIN_NETINFLOW_3D; change = item.f268; }
    else if(options.period === 'buy5d') { amount = !buyItem ? 0 : buyItem.MAIN_NETINFLOW_5D; change = !buyItem ? 0 : buyItem.MAIN_NETRATIO_5D; }
    else if(options.period === 'buy10d') { amount = !buyItem ? 0 : buyItem.MAIN_NETINFLOW_10D; change = item.f175; }
    else { amount = item.f62; change = item.f3;  }
    return { name, amount, change, code };
  }));
  return result;
}
async function getPeriodData(blockCode){
  const url = `/api/d/recentfunds/${blockCode}`;
  const res = await fetch(url);
  const data = await res.json();
  if(!data || !data.result || !data.result.data || data.result.data.length <= 0) return null;
  return data.result.data[0];
}
function setConitionFontSize(){
  if(window.innerWidth > 460){
    document.querySelectorAll('.chart-layout').forEach(el => {
      if(el.hasChildNodes){
        el.childNodes.forEach(x=>{
          if(x.classList && x.classList.contains('ft-12') >= 0) { x.classList.remove('ft-12'); x.classList.add('ft-14');}
        })
      }
    })
  }
  else{
    document.querySelectorAll('.chart-layout').forEach(el => {
      if(el.hasChildNodes){
        el.childNodes.forEach(x=>{
          if(x.classList && x.classList.contains('ft-14') >= 0) { x.classList.remove('ft-14'); x.classList.add('ft-12');}
        })
      }
    })
  }
}
</script>

</html>